<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单词热 - 听写模式</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="tw.build.css">
    <style>
        .wechat-container {
            max-width: 375px;
            margin: 0 auto;
            background: #f7f7f7;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .wechat-statusbar {
            height: 44px;
            background: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            color: white;
            font-size: 14px;
        }
        .wechat-navbar {
            height: 44px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            border-bottom: 1px solid #e5e5e5;
        }
        .audio-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: slideInDown 0.5s ease-out;
        }
        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .play-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .play-button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        .play-button.playing {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .waveform {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            gap: 2px;
        }
        .wave-bar {
            width: 3px;
            background: rgba(255,255,255,0.6);
            border-radius: 2px;
            animation: wave 1.5s ease-in-out infinite;
        }
        .wave-bar:nth-child(1) { height: 10px; animation-delay: 0s; }
        .wave-bar:nth-child(2) { height: 20px; animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { height: 30px; animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { height: 25px; animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { height: 15px; animation-delay: 0.4s; }
        .wave-bar:nth-child(6) { height: 35px; animation-delay: 0.5s; }
        .wave-bar:nth-child(7) { height: 20px; animation-delay: 0.6s; }
        .wave-bar:nth-child(8) { height: 25px; animation-delay: 0.7s; }
        .wave-bar:nth-child(9) { height: 15px; animation-delay: 0.8s; }
        .wave-bar:nth-child(10) { height: 10px; animation-delay: 0.9s; }
        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.3); }
        }
        .input-area {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .input-area:focus-within {
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .dictation-input {
            width: 100%;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 18px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f9fafb;
        }
        .dictation-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .dictation-input.correct {
            border-color: #10b981;
            background: #d1fae5;
            color: #047857;
        }
        .dictation-input.incorrect {
            border-color: #ef4444;
            background: #fee2e2;
            color: #dc2626;
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .speed-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .speed-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid #e5e7eb;
            background: white;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .speed-btn.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        .hint-section {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            transform: translateY(10px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .hint-section.show {
            transform: translateY(0);
            opacity: 1;
        }
        .progress-circle {
            stroke-dasharray: 251.2;
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        .floating-feedback {
            position: absolute;
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
            font-weight: bold;
            font-size: 18px;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
        }
        .recording-indicator {
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="wechat-container">
        <!-- 状态栏 -->
        <div class="wechat-statusbar">
            <span>9:41</span>
            <span>听写模式</span>
            <div class="flex items-center space-x-1">
                <i class="fas fa-signal text-xs"></i>
                <i class="fas fa-wifi text-xs"></i>
                <i class="fas fa-battery-three-quarters text-xs"></i>
            </div>
        </div>

        <!-- 导航栏 -->
        <div class="wechat-navbar">
            <button class="text-gray-600" onclick="safeBack('learning-modes.html')">
                <i class="fas fa-arrow-left text-lg"></i>
            </button>
            <div class="flex items-center space-x-2">
                <span id="libTitle" class="text-sm text-gray-600">中考必备词汇</span>
                <span class="bg-purple-100 text-purple-600 px-2 py-1 rounded-full text-xs" id="progressText">1/20</span>
            </div>
            <button class="text-gray-600" onclick="toggleHint()">
                <i class="fas fa-question-circle text-lg"></i>
            </button>
        </div>

        <!-- 进度条 -->
        <div class="px-4 py-3 bg-white border-b border-gray-200">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-600">听写进度</span>
                <span class="text-sm font-semibold text-purple-600" id="progressPercent">5%</span>
            </div>
            <div class="progress-brand"><div class="progress-brand-inner transition-all duration-500" style="width:5%" id="progressBar"></div></div>
        </div>

        <!-- 主要内容 -->
        <div class="flex-1 px-4 py-6">
            <!-- 音频播放卡片 -->
            <div class="text-white rounded-xl p-6 mb-6 text-center brand-gradient">
                <div class="mb-4">
                    <div class="play-button mx-auto mb-4" onclick="playAudio()" id="playButton">
                        <i class="fas fa-play text-2xl text-white" id="playIcon"></i>
                    </div>
                    <div class="waveform mb-4" id="waveform" style="display: none;">
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                    </div>
                </div>
                
                <!-- 播放速度控制 -->
                <div class="speed-control">
                    <button class="speed-btn" onclick="setSpeed(0.5)" id="speed-0.5">0.5x</button>
                    <button class="speed-btn active" onclick="setSpeed(1)" id="speed-1">1x</button>
                    <button class="speed-btn" onclick="setSpeed(1.5)" id="speed-1.5">1.5x</button>
                </div>
                
                <div class="bg-white/20 backdrop-blur-sm rounded-lg p-3">
                    <p class="text-sm text-white/80">点击播放按钮听单词发音</p>
                    <p class="text-xs text-white/60 mt-1">可重复播放，调节速度</p>
                </div>
            </div>

            <!-- 听写输入区域 -->
            <div class="input-area mb-6">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">请写出你听到的单词</h3>
                    <input type="text" 
                           class="dictation-input" 
                           placeholder="在此输入单词..." 
                           id="dictationInput"
                           autocomplete="off"
                           spellcheck="false">
                    <div class="flex justify-between items-center mt-3 text-sm text-gray-500">
                        <span>已输入: <span id="inputLength">0</span> 个字母</span>
                        <span>剩余机会: <span id="attemptsLeft">3</span></span>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button class="flex-1 btn-brand text-white py-3 rounded-xl font-semibold hover:brightness-110 transition-colors" 
                            onclick="checkAnswer()">
                        <i class="fas fa-check mr-2"></i>
                        检查答案
                    </button>
                    <button class="px-4 bg-gray-500 text-white py-3 rounded-xl font-semibold hover:bg-gray-600 transition-colors" 
                            onclick="clearInput()">
                        <i class="fas fa-eraser"></i>
                    </button>
                </div>
            </div>

            <!-- 提示区域 -->
            <div class="hint-section" id="hintSection">
                <div class="flex items-center mb-2">
                    <i class="fas fa-lightbulb mr-2"></i>
                    <span class="font-semibold">听写提示</span>
                </div>
                <div class="space-y-2 text-sm">
                    <p><strong>词性:</strong> <span id="wordType">名词</span></p>
                    <p><strong>首字母:</strong> <span id="firstLetter">A</span></p>
                    <p><strong>字母数:</strong> <span id="letterCount">9</span> 个字母</p>
                    <p><strong>含义提示:</strong> <span id="meaningHint">与"冒险"相关</span></p>
                </div>
            </div>

            <!-- 语音识别区域 -->
            <div class="bg-white rounded-xl p-4 mb-6 shadow-sm">
                <div class="text-center">
                    <h4 class="text-md font-semibold text-gray-800 mb-3">语音输入 (可选)</h4>
                    <button class="bg-red-500 text-white px-6 py-3 rounded-full font-semibold hover:bg-red-600 transition-colors" 
                            onclick="startVoiceRecognition()" id="voiceButton">
                        <i class="fas fa-microphone mr-2"></i>
                        开始录音
                    </button>
                    <div class="mt-3 text-sm text-gray-500" id="voiceStatus">点击按钮开始语音输入</div>
                </div>
            </div>
        </div>

        <!-- 统计信息 -->
        <div class="fixed bottom-4 right-4 bg-white rounded-full p-3 shadow-lg">
            <div class="relative w-12 h-12">
                <svg class="w-12 h-12 transform -rotate-90">
                    <circle cx="24" cy="24" r="20" stroke="#e5e7eb" stroke-width="4" fill="none"></circle>
                    <circle cx="24" cy="24" r="20" stroke="#8b5cf6" stroke-width="4" fill="none" 
                            class="progress-circle" stroke-linecap="round" id="statsCircle"></circle>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-xs font-bold text-purple-600" id="statsNumber">1</span>
                </div>
            </div>
        </div>

        <!-- 结果弹窗 -->
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" id="resultModal" style="display: none;">
            <div class="bg-white rounded-xl p-6 mx-4 max-w-sm w-full">
                <div class="text-center">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center" id="resultIcon">
                        <i class="fas fa-check text-3xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2" id="resultTitle">听写正确！</h3>
                    <p class="text-gray-600 mb-4" id="resultMessage">太棒了，继续保持！</p>
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <p class="text-lg font-bold text-gray-800 mb-1" id="correctWord">ADVENTURE</p>
                        <p class="text-sm text-gray-600 mb-2" id="wordPronunciation">/ədˈventʃər/</p>
                        <p class="text-sm text-gray-600" id="wordMeaning">冒险；奇遇</p>
                    </div>
                    <button class="w-full btn-brand text-white py-3 rounded-xl font-semibold" 
                            onclick="nextWord()">
                        下一个单词
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 查询参数与安全返回
        function getQueryParam(key) {
            const params = new URLSearchParams(window.location.search);
            return params.get(key);
        }
        function safeBack(fallbackUrl) {
            if (document.referrer && document.referrer !== window.location.href) {
                history.back();
            } else {
                window.location.href = fallbackUrl || 'learning-modes.html';
            }
        }
        let currentWordIndex = 0;
        let currentSpeed = 1;
        let attemptsLeft = 3;
        let correctCount = 0;
        let totalWords = 20;
        // 通过 URL 参数设置词库标题与总数
        const libFromUrl = getQueryParam('lib');
        if (libFromUrl) {
            const libTitleEl = document.getElementById('libTitle');
            if (libTitleEl) libTitleEl.textContent = libFromUrl;
        }
        const totalParam = parseInt(getQueryParam('total') || '', 10);
        if (!isNaN(totalParam)) {
            totalWords = totalParam;
            const progressEl = document.getElementById('progressText');
            if (progressEl) progressEl.textContent = `1/${totalWords}`;
        }
        let isPlaying = false;
        let recognition = null;
        
        const words = [
            {
                word: "ADVENTURE",
                pronunciation: "/ədˈventʃər/",
                meaning: "冒险；奇遇",
                type: "名词",
                hint: "与“冒险”相关"
            },
            {
                word: "BEAUTIFUL",
                pronunciation: "/ˈbjuːtɪfl/",
                meaning: "美丽的；漂亮的",
                type: "形容词",
                hint: "形容外观很好看"
            },
            {
                word: "CHALLENGE",
                pronunciation: "/ˈtʃælɪndʒ/",
                meaning: "挑战；质疑",
                type: "名词/动词",
                hint: "困难的任务或竞争"
            },
            {
                word: "DEVELOP",
                pronunciation: "/dɪˈveləp/",
                meaning: "发展；开发",
                type: "动词",
                hint: "成长或创造新事物"
            },
            {
                word: "EDUCATION",
                pronunciation: "/ˌedʒuˈkeɪʃn/",
                meaning: "教育；培养",
                type: "名词",
                hint: "学习和教学的过程"
            }
        ];

        function initializeWord() {
            const word = words[currentWordIndex];
            
            // 更新提示信息
            document.getElementById('wordType').textContent = word.type;
            document.getElementById('firstLetter').textContent = word.word[0];
            document.getElementById('letterCount').textContent = word.word.length;
            document.getElementById('meaningHint').textContent = word.hint;
            
            // 重置输入
            document.getElementById('dictationInput').value = '';
            document.getElementById('dictationInput').className = 'dictation-input';
            document.getElementById('inputLength').textContent = '0';
            
            // 重置尝试次数
            attemptsLeft = 3;
            document.getElementById('attemptsLeft').textContent = attemptsLeft;
            
            // 隐藏提示
            document.getElementById('hintSection').classList.remove('show');
            
            // 重置播放状态
            resetPlayButton();
        }

        function playAudio() {
            if (isPlaying) return;
            
            const word = words[currentWordIndex].word;
            const playButton = document.getElementById('playButton');
            const playIcon = document.getElementById('playIcon');
            const waveform = document.getElementById('waveform');
            
            isPlaying = true;
            playButton.classList.add('playing');
            playIcon.className = 'fas fa-pause text-2xl text-white';
            waveform.style.display = 'flex';
            
            // 模拟音频播放
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-US';
                utterance.rate = currentSpeed;
                
                utterance.onend = function() {
                    resetPlayButton();
                };
                
                speechSynthesis.speak(utterance);
            } else {
                // 如果不支持语音合成，模拟播放时间
                setTimeout(() => {
                    resetPlayButton();
                }, 2000);
            }
        }

        function resetPlayButton() {
            isPlaying = false;
            document.getElementById('playButton').classList.remove('playing');
            document.getElementById('playIcon').className = 'fas fa-play text-2xl text-white';
            document.getElementById('waveform').style.display = 'none';
        }

        function setSpeed(speed) {
            currentSpeed = speed;
            
            // 更新按钮状态
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`speed-${speed}`).classList.add('active');
        }

        function checkAnswer() {
            const input = document.getElementById('dictationInput');
            const userAnswer = input.value.trim().toUpperCase();
            const correctAnswer = words[currentWordIndex].word;
            
            if (!userAnswer) {
                alert('请输入单词');
                return;
            }
            
            if (userAnswer === correctAnswer) {
                input.classList.remove('incorrect');
                input.classList.add('correct');
                
                // 显示正确反馈
                createFloatingFeedback('正确！', 'text-green-500', input);
                
                setTimeout(() => {
                    showResult(true);
                }, 1000);
                
                correctCount++;
            } else {
                input.classList.remove('correct');
                input.classList.add('incorrect');
                
                attemptsLeft--;
                document.getElementById('attemptsLeft').textContent = attemptsLeft;
                
                // 显示错误反馈
                createFloatingFeedback('错误！', 'text-red-500', input);
                
                if (attemptsLeft <= 0) {
                    setTimeout(() => {
                        showResult(false);
                    }, 1000);
                } else {
                    // 给出更多提示
                    document.getElementById('hintSection').classList.add('show');
                }
            }
        }

        function clearInput() {
            const input = document.getElementById('dictationInput');
            input.value = '';
            input.className = 'dictation-input';
            document.getElementById('inputLength').textContent = '0';
        }

        function toggleHint() {
            const hintSection = document.getElementById('hintSection');
            hintSection.classList.toggle('show');
        }

        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('您的浏览器不支持语音识别功能');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            const voiceButton = document.getElementById('voiceButton');
            const voiceStatus = document.getElementById('voiceStatus');
            
            voiceButton.innerHTML = '<div class="recording-indicator mr-2"></div>录音中...';
            voiceButton.disabled = true;
            voiceStatus.textContent = '正在录音，请说出单词...';
            
            recognition.onresult = function(event) {
                const result = event.results[0][0].transcript.trim();
                document.getElementById('dictationInput').value = result;
                updateInputLength();
                voiceStatus.textContent = `识别结果: ${result}`;
            };
            
            recognition.onerror = function(event) {
                voiceStatus.textContent = '语音识别出错，请重试';
                resetVoiceButton();
            };
            
            recognition.onend = function() {
                resetVoiceButton();
            };
            
            recognition.start();
        }

        function resetVoiceButton() {
            const voiceButton = document.getElementById('voiceButton');
            const voiceStatus = document.getElementById('voiceStatus');
            
            voiceButton.innerHTML = '<i class="fas fa-microphone mr-2"></i>开始录音';
            voiceButton.disabled = false;
            voiceStatus.textContent = '点击按钮开始语音输入';
        }

        function updateInputLength() {
            const input = document.getElementById('dictationInput');
            document.getElementById('inputLength').textContent = input.value.length;
        }

        function showResult(isCorrect) {
            const modal = document.getElementById('resultModal');
            const icon = document.getElementById('resultIcon');
            const title = document.getElementById('resultTitle');
            const message = document.getElementById('resultMessage');
            
            if (isCorrect) {
                icon.className = 'w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center bg-green-500';
                icon.innerHTML = '<i class="fas fa-check text-3xl text-white"></i>';
                title.textContent = '听写正确！';
                message.textContent = '太棒了，继续保持！';
            } else {
                icon.className = 'w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center bg-red-500';
                icon.innerHTML = '<i class="fas fa-times text-3xl text-white"></i>';
                title.textContent = '听写错误';
                message.textContent = '没关系，继续努力！';
            }
            
            const word = words[currentWordIndex];
            document.getElementById('correctWord').textContent = word.word;
            document.getElementById('wordPronunciation').textContent = word.pronunciation;
            document.getElementById('wordMeaning').textContent = word.meaning;
            
            modal.style.display = 'flex';
        }

        function nextWord() {
            document.getElementById('resultModal').style.display = 'none';
            
            currentWordIndex++;
            
            if (currentWordIndex >= words.length) {
                showFinalResult();
                return;
            }
            
            // 更新进度
            updateProgress();
            
            // 初始化下一个单词
            initializeWord();
        }

        function updateProgress() {
            const progress = ((currentWordIndex + 1) / totalWords) * 100;
            document.getElementById('progressText').textContent = `${currentWordIndex + 1}/${totalWords}`;
            document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            // 更新圆形进度
            const circle = document.getElementById('statsCircle');
            const circumference = 2 * Math.PI * 20;
            const offset = circumference - (progress / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            document.getElementById('statsNumber').textContent = currentWordIndex + 1;
        }

        function createFloatingFeedback(text, className, element) {
            const floating = document.createElement('div');
            floating.className = `floating-feedback ${className}`;
            floating.textContent = text;
            floating.style.left = element.offsetLeft + element.offsetWidth / 2 + 'px';
            floating.style.top = element.offsetTop + 'px';
            
            element.parentElement.appendChild(floating);
            
            setTimeout(() => {
                floating.remove();
            }, 2000);
        }

        function showFinalResult() {
            const accuracy = Math.round((correctCount / words.length) * 100);
            alert(`听写练习完成！\n正确率：${accuracy}%\n正确单词：${correctCount}/${words.length}`);
        }

        // 输入框事件监听
        document.getElementById('dictationInput').addEventListener('input', updateInputLength);
        
        // 回车键提交
        document.getElementById('dictationInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });

        // 初始化
        initializeWord();
        updateProgress();
    </script>
</body>
</html>
